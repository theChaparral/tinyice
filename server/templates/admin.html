<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TinyIce Admin</title>
    <script src="/assets/js/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg: #0b0f1a; --surface: #161b2c; --surface-hover: #1e253a;
            --primary: #38bdf8; --primary-glow: rgba(56, 189, 248, 0.15);
            --text: #f1f5f9; --text-dim: #94a3b8; --border: #2d3748;
            --success: #10b981; --danger: #f87171; --warning: #f59e0b;
        }
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; line-height: 1.5; overflow: hidden; }
        .app-container { display: flex; height: 100vh; width: 100vw; }
        aside { background: var(--surface); border-right: 1px solid var(--border); padding: 2rem; display: flex; flex-direction: column; width: 280px; height: 100vh; box-sizing: border-box; flex-shrink: 0; }
        .logo-img { width: 100%; max-width: 180px; margin-bottom: 2rem; display: block; }
        main { flex: 1; padding: 2.5rem; height: 100vh; overflow-y: auto; box-sizing: border-box; min-width: 0; }
        h2 { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
        h2::before { content: ''; width: 4px; height: 1.25rem; background: var(--primary); border-radius: 2px; }
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; }
        .stat-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; text-align: center; }
        .stat-card .label { color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 0.5rem; }
        .stat-card .value { font-size: 2.5rem; font-weight: 800; color: var(--primary); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 0.6rem 1.2rem; border-radius: 8px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; text-decoration: none; border: none; }
        .btn-primary { background: var(--primary); color: var(--bg); }
        .btn-outline { border: 1px solid var(--border); color: var(--text); background: transparent; }
        .btn-outline:hover { background: var(--surface-hover); }
        .btn-sm { padding: 0.35rem 0.75rem; font-size: 0.8rem; }
        .btn-danger { background: rgba(248, 113, 113, 0.1); color: var(--danger); border: 1px solid rgba(248, 113, 113, 0.2); }
        .btn-danger:hover { background: var(--danger); color: var(--bg); }
        .btn-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        .btn-warning:hover { background: var(--warning); color: var(--bg); }
        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        th { text-align: left; font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; padding: 1rem; border-bottom: 1px solid var(--border); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); font-size: 0.9rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .mount-code { font-family: ui-monospace, monospace; color: var(--primary); background: rgba(56, 189, 248, 0.1); padding: 0.2rem 0.4rem; border-radius: 4px; }
        .mount-disabled { text-decoration: line-through; color: var(--text-dim); }
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 0.5rem; }
        input, select { width: 100%; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; color: var(--text); box-sizing: border-box; }
        .nav-link { display: flex; align-items: center; gap: 0.75rem; color: var(--text-dim); text-decoration: none; padding: 0.75rem 1rem; border-radius: 8px; margin-bottom: 0.5rem; cursor: pointer; border: none; background: transparent; width: 100%; text-align: left; font-size: 1rem; }
        .nav-link i, .nav-link svg { width: 1.25rem; height: 1.25rem; }
        .nav-link:hover { background: var(--surface-hover); color: var(--text); }
        .nav-link.active { color: var(--primary); background: var(--primary-glow); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .role-badge { font-size: 0.7rem; padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: 800; text-transform: uppercase; margin-left: 0.5rem; }
        .role-super { background: var(--primary); color: var(--bg); }
        .role-admin { background: var(--border); color: var(--text); }
        .badge-transcoded { background: rgba(168, 85, 247, 0.1); color: #a855f7; font-size: 0.6rem; padding: 0.1rem 0.4rem; border-radius: 4px; font-weight: 800; border: 1px solid rgba(168, 85, 247, 0.2); margin-left: 0.5rem; text-transform: uppercase; }
        .status-pill { display: inline-flex; align-items: center; gap: 0.4rem; background: rgba(16, 185, 129, 0.1); color: var(--success); padding: 0.2rem 0.6rem; border-radius: 100px; font-size: 0.75rem; font-weight: 700; }
        .status-pill.inactive { color: var(--text-dim); background: rgba(255,255,255,0.05); }
        .dot { width: 6px; height: 6px; background: currentColor; border-radius: 50%; }
        .song-title { font-weight: 600; color: var(--warning); display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }
        .history-sidebar { border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .history-mount-btn { padding: 1rem; border: none; background: transparent; color: var(--text-dim); text-align: left; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 0.9rem; width: 100%; }
        .history-mount-btn:hover { background: var(--surface-hover); color: var(--text); }
        .history-mount-btn.active { color: var(--primary); background: var(--primary-glow); font-weight: 700; }
        .playlist-item.active { border-color: var(--primary) !important; background: var(--primary-glow) !important; }
        .playlist-item.active span { color: var(--primary); font-weight: 600; }
        .sortable-ghost { opacity: 0.4; background: var(--primary-glow) !important; }
    </style>
</head>
<body>
    <div class="app-container">
        <aside>
            <a href="/" style="text-decoration: none;">
                <img src="/assets/logo.png" alt="TinyIce" class="logo-img">
            </a>
            <div id="sidebar-nav">
                <button class="nav-link active" onclick="showTab('tab-overview')"><i data-lucide="layout-dashboard"></i> Dashboard</button>
                <button class="nav-link" onclick="showTab('tab-stations')"><i data-lucide="tower-control"></i> Your Stations</button>
                <button class="nav-link" onclick="showTab('tab-history')"><i data-lucide="file-audio"></i> Play History</button>
                {{if eq .User.Role "superadmin"}}
                <button class="nav-link" onclick="showTab('tab-users')"><i data-lucide="users"></i> User Management</button>
                <button class="nav-link" onclick="showTab('tab-relays')"><i data-lucide="refresh-ccw"></i> Edge Relays</button>
                <button class="nav-link" onclick="showTab('tab-streamer')"><i data-lucide="play-circle"></i> Internal Streamer</button>
                <button class="nav-link" onclick="showTab('tab-transcoding')"><i data-lucide="scissors"></i> Transcoding</button>
                <button class="nav-link" onclick="showTab('tab-webhooks')"><i data-lucide="webhook"></i> Webhooks</button>
                <button class="nav-link" onclick="showTab('tab-security')"><i data-lucide="shield-check"></i> Security & Bans</button>
                {{end}}
                <button class="nav-link" onclick="showTab('tab-insights')"><i data-lucide="trending-up"></i> Insights</button>
                <a href="/logout" class="nav-link" style="color: var(--danger); margin-top: 1rem; text-decoration: none;"><i data-lucide="log-out"></i> Sign Out</a>
            </div>
            <div style="margin-top: auto; padding-top: 2rem;">
                <div style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 1rem;">User: <strong>{{.User.Username}}</strong> <span class="role-badge {{if eq .User.Role "superadmin"}}role-super{{else}}role-admin{{end}}">{{.User.Role}}</span></div>
                <div style="font-size: 0.75rem; color: var(--text-dim);">Powered by TinyIce<br>Host: {{.Config.HostName}}</div>
            </div>
        </aside>
        <main>
            <div class="stat-cards">
                <div class="stat-card"><div class="label">Listeners</div><div class="value" id="global-listeners">0</div></div>
                <div class="stat-card">
                    <div class="label">Active Sources</div>
                    <div class="value" id="global-sources">0</div>
                    <div style="font-size: 0.7rem; color: var(--text-dim); margin-top: 0.5rem;"><span id="stat-streamers" style="color: var(--success)">0</span> DIRECT / <span id="stat-relays" style="color: var(--warning)">0</span> RELAY</div>
                </div>
                <div class="stat-card"><div class="label">Traffic MB In</div><div class="value" id="global-mb-in">0.0</div></div>
                <div class="stat-card"><div class="label">Traffic MB Out</div><div class="value" id="global-mb-out">0.0</div></div>
            </div>
            <section id="debug-stats" style="display: none; margin-bottom: 2rem;">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem;">
                    <div class="card" style="padding: 1rem; text-align: center; border-color: var(--warning);">
                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">SYSTEM RAM</div>
                        <div class="value" style="font-size: 1.5rem; color: var(--warning);" id="debug-ram">0 Bytes</div>
                    </div>
                    <div class="card" style="padding: 1rem; text-align: center; border-color: var(--warning);">
                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">HEAP ALLOC</div>
                        <div class="value" style="font-size: 1.5rem; color: var(--warning);" id="debug-heap">0 Bytes</div>
                    </div>
                    <div class="card" style="padding: 1rem; text-align: center; border-color: var(--warning);">
                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">STACK RAM</div>
                        <div class="value" style="font-size: 1.5rem; color: var(--warning);" id="debug-stack">0 Bytes</div>
                    </div>
                    <div class="card" style="padding: 1rem; text-align: center; border-color: var(--warning);">
                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">GC CYCLES</div>
                        <div class="value" style="font-size: 1.5rem; color: var(--warning);" id="debug-gc">0</div>
                    </div>
                    <div class="card" style="padding: 1rem; text-align: center; border-color: var(--danger);">
                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">GOROUTINES</div>
                        <div class="value" style="font-size: 1.5rem; color: var(--danger);" id="debug-goroutines">0</div>
                    </div>
                    <div class="card" style="padding: 1rem; text-align: center; border-color: var(--danger);">
                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">TOTAL LOSS</div>
                        <div class="value" style="font-size: 1.5rem; color: var(--danger);" id="debug-loss">0 Bytes</div>
                    </div>
                    <div class="card" style="padding: 1rem; text-align: center; border-color: var(--primary);">
                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">SERVER UPTIME</div>
                        <div class="value" style="font-size: 1.5rem; color: var(--primary);" id="debug-uptime">0s</div>
                    </div>
                </div>
            </section>
            <div id="tab-overview" class="tab-content active">
                <section>
                    <h2>Live Traffic</h2>
                    <div class="card" style="padding: 1.5rem;"><canvas id="trafficChart" style="width: 100%; height: 180px;"></canvas><div style="display: flex; gap: 2rem; justify-content: center; margin-top: 0.5rem; font-size: 0.85rem;"><span>Out: <strong id="outRate" style="color: #38bdf8">0</strong> KB/s</span><span>In: <strong id="inRate" style="color: #10b981">0</strong> KB/s</span></div></div>
                </section>
                <section>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"><h2>Active Broadcasts</h2>{{if eq .User.Role "superadmin"}}<form action="/admin/kick-all-listeners" method="POST" onsubmit="return confirm('Kick ALL?')"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><button type="submit" class="btn btn-danger btn-sm">KICK ALL LISTENERS</button></form>{{end}}</div>
                                    <div class="card" style="padding: 0; overflow: hidden;">
                                        <table><thead><tr><th style="width:15%">Mount</th><th style="width:20%">Now Playing</th><th style="width:10%">Listeners</th><th style="width:15%">Traffic</th><th style="width:10%">Health</th><th style="width:10%">Uptime</th><th style="width:20%">Action</th></tr></thead><tbody id="streamsBody">
                                            {{range .Streams}}<tr data-mount="{{.MountName}}"><td><span class="mount-code row-mount">{{.MountName}}</span><br><span style="font-size:0.7rem;color:var(--text-dim)" class="row-ip">{{.SourceIP}}</span></td><td><span class="song-title row-song">{{.CurrentSong}}</span></td><td style="font-weight:700;color:var(--primary);" class="row-listeners">{{.ListenersCount}}</td><td><span style="color:var(--success)" class="row-in">0.0</span> / <span style="color:var(--primary)" class="row-out">0.0</span></td><td><span class="row-health" style="font-weight:bold; color:var(--success)">100%</span></td><td style="font-family:monospace;" class="row-uptime">{{.Uptime}}</td><td><div style="display:flex;gap:0.5rem;"><a href="/player{{.MountName}}" target="_blank" class="btn btn-outline btn-sm row-link">Listen</a><button type="button" class="btn btn-primary btn-sm" onclick="shareStream('{{.MountName}}')">SHARE</button><form action="/admin/kick" method="POST" style="display:inline;"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{.MountName}}"><button type="submit" class="btn btn-danger btn-sm">KICK</button></form></div></td></tr>{{end}}
                                        </tbody></table>
                                    </div>
                    
                </section>
            </div>
            <div id="tab-stations" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem;">
                    <section><h2>Provision Station</h2><div class="card"><form action="/admin/add-mount" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><div class="form-group"><label>Mount Path</label><input type="text" id="add-mount-path" name="mount" placeholder="/live" required></div><div class="form-group"><label>Source Password</label><div style="display: flex; gap: 0.5rem;"><input type="text" name="password" id="new-mount-pw" required><button type="button" id="gen-pw" class="btn btn-outline btn-sm">GENERATE</button></div></div><button type="submit" class="btn btn-primary" style="width: 100%;">Save Station</button></form></div></section>
                    <section><h2>Managed Stations</h2><div class="card" style="padding: 0;"><table><thead><tr><th style="width:25%">Mount</th><th style="width:25%">Fallback</th><th style="width:50%">Actions</th></tr></thead><tbody>
                        {{range $mount, $pass := .User.Mounts}}{{ $disabled := index $.Config.DisabledMounts $mount }}{{ $visible := index $.Config.VisibleMounts $mount }}{{ $fallback := index $.FallbackMounts $mount }}<tr><td><span class="mount-code {{if $disabled}}mount-disabled{{end}}">{{$mount}}</span></td><td><form action="/admin/update-fallback" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{$mount}}"><input type="text" name="fallback" value="{{$fallback}}" placeholder="e.g. /backup" style="padding: 0.2rem; font-size: 0.8rem; width: 80%;" onchange="this.form.submit()"></form></td><td><div style="display:flex; gap:0.3rem"><button type="button" class="btn btn-outline btn-sm edit-mount" data-mount="{{$mount}}">EDIT</button><form action="/admin/toggle-visible" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{$mount}}"><button type="submit" class="btn {{if $visible}}btn-outline{{else}}btn-primary{{end}} btn-sm">{{if $visible}}HIDE{{else}}APPROVE{{end}}</button></form><form action="/admin/toggle-mount" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{$mount}}"><button type="submit" class="btn {{if $disabled}}btn-primary{{else}}btn-warning{{end}} btn-sm">{{if $disabled}}ENABLE{{else}}DISABLE{{end}}</button></form><form action="/admin/remove-mount" method="POST" onsubmit="return confirm('Remove?')"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{$mount}}"><button type="submit" class="btn btn-danger btn-sm">REMOVE</button></form></div></td></tr>{{end}}
                        {{if eq .User.Role "superadmin"}}{{range $mount, $pass := .Config.Mounts}}{{ $disabled := index $.Config.DisabledMounts $mount }}{{ $visible := index $.Config.VisibleMounts $mount }}{{ $fallback := index $.FallbackMounts $mount }}<tr><td><span class="mount-code {{if $disabled}}mount-disabled{{end}}">{{$mount}}</span> (Global)</td><td><form action="/admin/update-fallback" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{$mount}}"><input type="text" name="fallback" value="{{$fallback}}" placeholder="e.g. /backup" style="padding: 0.2rem; font-size: 0.8rem; width: 80%;" onchange="this.form.submit()"></form></td><td><div style="display:flex;gap:0.3rem"><button type="button" class="btn btn-outline btn-sm edit-mount" data-mount="{{$mount}}">EDIT</button><form action="/admin/toggle-visible" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{$mount}}"><button type="submit" class="btn {{if $visible}}btn-outline{{else}}btn-primary{{end}} btn-sm">{{if $visible}}HIDE{{else}}APPROVE{{end}}</button></form><form action="/admin/remove-mount" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="mount" value="{{$mount}}"><button type="submit" class="btn btn-danger btn-sm">REMOVE</button></form></div></td></tr>{{end}}{{end}}
                    </tbody></table></div></section>
                </div>
            </div>
            <div id="tab-history" class="tab-content">
                <section>
                    <h2>Playback History</h2>
                    <div class="card" style="padding: 0; display: grid; grid-template-columns: 250px 1fr; min-height: 500px;">
                        <div class="history-sidebar">
                            <div style="padding: 1rem; font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; border-bottom: 1px solid var(--border);">Select Mount</div>
                            <div id="history-mount-list" style="overflow-y: auto;">
                                {{range .Mounts}}
                                <button class="history-mount-btn" onclick="loadHistory('{{.}}', this)">{{.}}</button>
                                {{else}}
                                <div style="padding: 2rem; text-align: center; color: var(--text-dim); font-size: 0.8rem;">No mounts configured.</div>
                                {{end}}
                            </div>
                        </div>
                        <div style="display: flex; flex-direction: column;">
                            <div style="padding: 1rem; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.1); font-weight: 600;" id="history-current-mount">Select a mount to view history</div>
                            <div style="overflow-y: auto; flex-grow: 1;">
                                <table>
                                    <thead><tr><th style="width:70%">Song Title</th><th style="width:30%">Played At</th></tr></thead>
                                    <tbody id="historyBody">
                                        <tr><td colspan="2" style="text-align:center; padding:5rem; color:var(--text-dim)">History will appear here.</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
            {{if eq .User.Role "superadmin"}}
                        <div id="tab-insights" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <h2>Historical Insights & Trends</h2>
                    <div id="insights-legend" style="display: flex; gap: 1rem; flex-wrap: wrap;"></div>
                </div>
                <div class="card" style="padding: 2rem; margin-bottom: 2rem;">
                    <h3>24-Hour Listener Trends</h3>
                    <canvas id="insightsChart" style="width: 100%; height: 350px;"></canvas>
                </div>
                <div id="insights-summary" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-bottom: 3rem;">
                    <!-- Populated via JS -->
                </div>

                <section>
                    <h2>Top Streams (Current Listeners)</h2>
                    <div class="card" style="padding: 0; overflow: hidden; margin-bottom: 2rem;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Mount</th>
                                    <th>Name</th>
                                    <th>Listeners</th>
                                    <th>Bitrate</th>
                                </tr>
                            </thead>
                            <tbody id="topStreamsBody"></tbody>
                        </table>
                    </div>
                </section>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <section>
                        <h2>Top Listener User-Agents</h2>
                        <div class="card" style="padding: 0; overflow: hidden;">
                            <table>
                                <thead><tr><th>User-Agent</th><th>Hits</th></tr></thead>
                                <tbody id="topListenersUABody"></tbody>
                            </table>
                        </div>
                    </section>
                    <section>
                        <h2>Top Source User-Agents</h2>
                        <div class="card" style="padding: 0; overflow: hidden;">
                            <table>
                                <thead><tr><th>User-Agent</th><th>Hits</th></tr></thead>
                                <tbody id="topSourcesUABody"></tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
            <div id="tab-users" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;"><section><h2>Create Admin</h2><div class="card"><form action="/admin/add-user" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><div class="form-group"><label>Username</label><input type="text" name="username" required></div><div class="form-group"><label>Password</label><input type="password" name="password" required></div><button type="submit" class="btn btn-primary">Add User</button></form></div></section><section><h2>System Users</h2><div class="card" style="padding: 0;"><table><thead><tr><th style="width:40%">User</th><th style="width:30%">Role</th><th style="width:30%">Action</th></tr></thead><tbody>{{range .Config.Users}}<tr><td>{{.Username}}</td><td>{{.Role}}</td><td>{{if ne .Role "superadmin"}}<form action="/admin/remove-user" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="username" value="{{.Username}}"><button type="submit" class="btn btn-danger btn-sm">DELETE</button></form>{{end}}</td></tr>{{end}}</tbody></table></div></section></div></div>
            <div id="tab-relays" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem;">
                    <section><h2>Configure Relay</h2><div class="card"><form action="/admin/add-relay" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><div class="form-group"><label>Source URL</label><input type="text" id="add-relay-url" name="url" placeholder="http://master:8000/live" required></div><div class="form-group"><label>Local Mount</label><input type="text" id="add-relay-mount" name="mount" placeholder="/relay" required></div><div class="form-group"><label>Password</label><input type="password" id="add-relay-password" name="password"></div><div class="form-group"><label>Burst Size</label><input type="number" id="add-relay-burst" name="burst_size" value="20"></div><button type="submit" class="btn btn-primary">Start Relay</button></form></div></section>
                    <section><h2>Active Edge Relays</h2><div class="card" style="padding: 0;"><table><thead><tr><th style="width:10%">Status</th><th style="width:25%">Target</th><th style="width:15%">Local Mount</th><th style="width:50%">Action</th></tr></thead><tbody id="relaysBody"></tbody></table></div></section>
                </div>
            </div>
                        <div id="tab-transcoding" class="tab-content">
                            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem;">
                                <section>
                                    <h2>New Transcoder</h2>
                                    <div class="card">
                                        <form action="/admin/add-transcoder" method="POST">
                                            <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                            <div class="form-group"><label>Instance Name</label><input type="text" name="name" placeholder="MP3 to Opus" required></div>
                                            <div class="form-group"><label>Input Mount</label><input type="text" name="input" placeholder="/live" required></div>
                                            <div class="form-group"><label>Output Mount</label><input type="text" name="output" placeholder="/opus" required></div>
                                            <div class="form-group">
                                                <label>Format</label>
                                                                                    <select name="format">
                                                                                        <option value="mp3">MP3</option>
                                                                                        <option value="opus">Opus</option>
                                                                                    </select>
                                                
                                            </div>
                                            <div class="form-group"><label>Bitrate (kbps)</label><input type="number" name="bitrate" value="128" required></div>
                                            <button type="submit" class="btn btn-primary" style="width: 100%;">Start Transcoder</button>
                                        </form>
                                    </div>
                                </section>
                                <section>
                                    <h2>Active Transcoders</h2>
                                    <div class="card" style="padding: 0; overflow: hidden;">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Name</th>
                                                    <th>Flow</th>
                                                    <th>Stats</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="transcodersBody"></tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div id="tab-webhooks" class="tab-content">
                            <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 2rem;">
                                <section>
                                    <h2>Configure Webhook</h2>
                                    <div class="card">
                                        <form action="/admin/add-webhook" method="POST">
                                            <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                            <div class="form-group"><label>Target URL</label><input type="text" name="url" placeholder="https://discord.com/api/webhooks/..." required></div>
                                            <div class="form-group">
                                                <label>Event Triggers</label>
                                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; text-align: left; font-size: 0.8rem;">
                                                    <label style="text-transform: none; display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="events" value="source_connect" checked> Source Connect</label>
                                                    <label style="text-transform: none; display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="events" value="source_disconnect" checked> Source Disconnect</label>
                                                    <label style="text-transform: none; display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="events" value="metadata_update" checked> Song Changes</label>
                                                    <label style="text-transform: none; display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" name="events" value="security_lockout" checked> Security Alerts</label>
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-primary" style="width: 100%;">Save Webhook</button>
                                        </form>
                                    </div>
                                </section>
                                <section>
                                    <h2>Active Webhooks</h2>
                                    <div class="card" style="padding: 0; overflow: hidden;">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Target URL</th>
                                                    <th>Events</th>
                                                    <th>Action</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {{range .Config.Webhooks}}
                                                <tr>
                                                    <td style="font-size: 0.75rem; color: var(--text-dim); max-width: 200px; overflow: hidden; text-overflow: ellipsis;">{{.URL}}</td>
                                                    <td style="font-size: 0.7rem;">
                                                        {{range .Events}}
                                                        <span class="genre-tag" style="margin-right: 2px; margin-bottom: 2px; font-size: 0.6rem;">{{.}}</span>
                                                        {{end}}
                                                    </td>
                                                    <td>
                                                        <form action="/admin/delete-webhook" method="POST" onsubmit="return confirm('Delete?')">
                                                            <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                                            <input type="hidden" name="url" value="{{.URL}}">
                                                            <button type="submit" class="btn btn-danger btn-sm">DELETE</button>
                                                        </form>
                                                    </td>
                                                </tr>
                                                {{else}}
                                                <tr><td colspan="3" style="text-align: center; padding: 2rem;">No webhooks configured.</td></tr>
                                                {{end}}
                                            </tbody>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div id="tab-streamer" class="tab-content">
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                    <section>
                        <h2>Provision AutoDJ</h2>
                        <div class="card">
                            <form action="/admin/autodj/add" method="POST">
                                <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                <div class="form-group"><label>Instance Name</label><input type="text" name="name" placeholder="24/7 Chill" required></div>
                                <div class="form-group"><label>Mount Path</label><input type="text" name="mount" placeholder="/autodj" required></div>
                                <div class="form-group"><label>Music Directory</label><input type="text" name="music_dir" placeholder="/var/music/chill" required></div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div class="form-group">
                                        <label>Format</label>
                                        <select name="format">
                                            <option value="mp3">MP3</option>
                                            <option value="opus">Opus</option>
                                        </select>
                                    </div>
                                    <div class="form-group"><label>Bitrate (kbps)</label><input type="number" name="bitrate" value="128" required></div>
                                </div>
                                <div class="form-group" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" name="loop" id="adj-loop" checked style="width: auto;">
                                    <label for="adj-loop" style="margin-bottom: 0;">Loop Playlist</label>
                                </div>
                                <button type="submit" class="btn btn-primary" style="width: 100%;">Create AutoDJ</button>
                            </form>
                        </div>
                    </section>
                    <section>
                        <h2>Active AutoDJs</h2>
                        <div id="autodj-list">
                            {{range .Streamers}}
                            <div class="card" style="margin-bottom: 1.5rem; padding: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                            {{.Name}} 
                                            <span class="status-pill {{if ne .State 1}}inactive{{end}}" style="font-size: 0.6rem; padding: 0.1rem 0.4rem;">
                                                <div class="dot"></div> {{if eq .State 1}}LIVE{{else}}IDLE{{end}}
                                            </span>
                                        </h3>
                                        <div style="font-size: 0.8rem; color: var(--text-dim); margin-top: 0.2rem;">
                                            Mount: <span class="mount-code">{{.OutputMount}}</span> | 
                                            Format: <span style="font-weight: bold; color: var(--primary);">{{.Format}} {{.Bitrate}}K</span> |
                                            Dir: <span style="font-family: monospace; font-size: 0.75rem;">{{.MusicDir}}</span>
                                        </div>
                                    </div>
                                <div style="display: flex; gap: 0.5rem;">
                                        <form action="/admin/player/shuffle" method="POST">
                                            <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                            <input type="hidden" name="mount" value="{{.OutputMount}}">
                                            <button type="submit" class="btn {{if .Shuffle}}btn-primary{{else}}btn-outline{{end}} btn-sm" title="Toggle Shuffle">
                                                <i data-lucide="shuffle" style="width: 14px; height: 14px;"></i>
                                            </button>
                                        </form>
                                        <a href="/player{{.OutputMount}}" target="_blank" class="btn btn-outline btn-sm"><i data-lucide="headphones" style="width: 14px; height: 14px; margin-right: 4px;"></i> MONITOR</a>
                                        <form action="/admin/autodj/toggle" method="POST">
                                            <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                            <input type="hidden" name="mount" value="{{.OutputMount}}">
                                            <button type="submit" class="btn {{if eq .State 1}}btn-warning{{else}}btn-primary{{end}} btn-sm">
                                                {{if eq .State 1}}STOP{{else}}START{{end}}
                                            </button>
                                        </form>
                                        <form action="/admin/autodj/delete" method="POST" onsubmit="return confirm('Delete this AutoDJ?')">
                                            <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                            <input type="hidden" name="mount" value="{{.OutputMount}}">
                                            <button type="submit" class="btn btn-danger btn-sm">DELETE</button>
                                        </form>
                                    </div>
                                </div>

                                {{if eq .State 1}}
                                <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; border: 1px solid var(--border);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                        <div class="label" style="font-size: 0.7rem; color: var(--text-dim);">NOW PLAYING</div>
                                        <div style="font-size: 0.7rem; color: var(--primary); font-family: monospace;">
                                            Playlist: {{.CurrentPos}} / {{len .Playlist}}
                                        </div>
                                    </div>
                                    <div class="song-title" style="font-size: 1rem; color: var(--text); margin-bottom: 0.75rem;">
                                        {{if .CurrentFile}}{{.CurrentFile}}{{else}}Preparing...{{end}}
                                    </div>
                                    <div style="height: 4px; background: var(--bg); border-radius: 2px; overflow: hidden; position: relative;">
                                        <div class="progress-bar-adj" data-start="{{.CurrentFileTime.Unix}}" style="height: 100%; background: var(--primary); width: 0%; transition: width 1s linear;"></div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-top: 0.4rem; font-size: 0.7rem; color: var(--text-dim); font-family: monospace;">
                                        <span class="progress-time-current">00:00</span>
                                        <span class="progress-time-total">--:--</span>
                                    </div>
                                </div>
                                {{end}}

                                <div style="margin-top: 1.5rem;">
                                    {{if .Queue}}
                                    <div style="margin-bottom: 1rem;">
                                        <div class="label" style="font-size: 0.65rem; color: var(--primary); margin-bottom: 0.5rem; letter-spacing: 1px;">UP NEXT (QUEUE)</div>
                                        <div style="display: flex; flex-direction: column; gap: 0.4rem;">
                                            {{range $qidx, $qfile := .Queue}}
                                            <div style="display: flex; justify-content: space-between; align-items: center; background: rgba(56, 189, 248, 0.05); padding: 0.5rem; border-radius: 4px; border: 1px dashed var(--primary-glow);">
                                                <span style="font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{$qfile}}</span>
                                                <form action="/admin/player/queue" method="POST">
                                                    <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                                    <input type="hidden" name="mount" value="{{$.OutputMount}}">
                                                    <input type="hidden" name="action" value="remove">
                                                    <input type="hidden" name="index" value="{{$qidx}}">
                                                    <button type="submit" style="background:none; border:none; color:var(--danger); cursor:pointer;"><i data-lucide="x-circle" style="width:14px; height:14px;"></i></button>
                                                </form>
                                            </div>
                                            {{end}}
                                        </div>
                                    </div>
                                    {{end}}

                                    <div class="label" style="font-size: 0.65rem; color: var(--text-dim); margin-bottom: 0.5rem; letter-spacing: 1px;">PLAYLIST (DRAG TO REORDER)</div>
                                    <div class="playlist-sortable" data-mount="{{.OutputMount}}" style="max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 2px;">
                                        {{$current := .CurrentPos}}
                                        {{range $idx, $file := .Playlist}}
                                        <div class="playlist-item {{if and (not $.Shuffle) (eq $idx $current)}}active{{end}}" data-index="{{$idx}}" style="display: flex; justify-content: space-between; align-items: center; background: var(--bg); padding: 0.6rem; border-radius: 4px; cursor: grab; border: 1px solid transparent;">
                                            <div style="display: flex; align-items: center; gap: 0.75rem; overflow: hidden;">
                                                <i data-lucide="grip-vertical" style="width: 14px; height: 14px; color: var(--border);"></i>
                                                <span style="font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">{{$file}}</span>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <form action="/admin/player/queue" method="POST">
                                                    <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                                    <input type="hidden" name="mount" value="{{$.OutputMount}}">
                                                    <input type="hidden" name="action" value="add">
                                                    <input type="hidden" name="path" value="{{$file}}">
                                                    <button type="submit" class="btn btn-outline btn-sm" style="padding: 0.2rem 0.4rem;" title="Add to Queue"><i data-lucide="list-plus" style="width: 14px; height: 14px;"></i></button>
                                                </form>
                                            </div>
                                        </div>
                                        {{end}}
                                    </div>
                                </div>

                                <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                                    <form action="/admin/player/scan" method="POST" style="flex: 1;">
                                        <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                        <input type="hidden" name="mount" value="{{.OutputMount}}">
                                        <button type="submit" class="btn btn-outline btn-sm" style="width: 100%;"><i data-lucide="refresh-cw" style="width: 12px; height: 12px; margin-right: 4px;"></i> RESCAN DIRECTORY</button>
                                    </form>
                                    <form action="/admin/player/toggle" method="POST" style="flex: 1;">
                                        <input type="hidden" name="csrf" value="{{$.CSRFToken}}">
                                        <input type="hidden" name="mount" value="{{.OutputMount}}">
                                        <button type="submit" class="btn btn-outline btn-sm" style="width: 100%;">
                                            {{if eq .State 1}}PAUSE{{else}}RESUME{{end}}
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {{else}}
                            <div class="card" style="text-align: center; padding: 4rem; color: var(--text-dim); border-style: dashed;">
                                <i data-lucide="music" style="width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3;"></i>
                                <p>No AutoDJs configured yet.</p>
                                <p style="font-size: 0.8rem;">Provision your first instance using the form on the left.</p>
                            </div>
                            {{end}}
                        </div>
                    </section>
                </div>
            </div>
            <div id="tab-security" class="tab-content">
            <div style="grid-template-columns: 1fr 1fr; display: grid; gap: 2rem;"><section><h2>Ban Address or Range</h2><div class="card"><form action="/admin/add-banned-ip" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><div class="form-group"><label>IP Address or CIDR Range</label><input type="text" name="ip" placeholder="e.g. 1.2.3.4 or 192.168.1.0/24" required></div><button type="submit" class="btn btn-danger">Ban Address</button></form></div></section><section><h2>Access Control List</h2><div class="card" style="padding: 0;"><table><thead><tr><th style="width:70%">Banned IP / Range</th><th style="width:30%">Action</th></tr></thead><tbody>{{range .Config.BannedIPs}}<tr><td>{{.}}</td><td><form action="/admin/remove-banned-ip" method="POST"><input type="hidden" name="csrf" value="{{$.CSRFToken}}"><input type="hidden" name="ip" value="{{.}}"><button type="submit" class="btn btn-outline btn-sm">Unban</button></form></td></tr>{{else}}<tr><td colspan="2" style="text-align:center; padding:2rem">No active bans.</td></tr>{{end}}</tbody></table></div></section></div>
            
            <div style="grid-template-columns: 1fr 1fr; display: grid; gap: 2rem; margin-top: 3rem;">
                <section>
                    <h2>Top Authentication Failures</h2>
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <table>
                            <thead><tr><th>IP Address</th><th>Fails</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody id="authFailsBody"></tbody>
                        </table>
                    </div>
                </section>
                <section>
                    <h2>Top Connection Scanners (404s)</h2>
                    <div class="card" style="padding: 0; overflow: hidden;">
                        <table>
                            <thead><tr><th>IP Address</th><th>Hits</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody id="scannersBody"></tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
            {{end}}
        </main>
    </div>
        <template id="stream-row-template"><tr><td><span class="mount-code row-mount"></span><br><span style="font-size:0.7rem;color:var(--text-dim)" class="row-ip"></span></td><td><span class="song-title row-song"></span></td><td style="font-weight:700;color:var(--primary);" class="row-listeners"></td><td><span style="color:var(--success)" class="row-in"></span> / <span style="color:var(--primary)" class="row-out"></span></td><td><span class="row-health"></span></td><td style="font-family:monospace;" class="row-uptime"></span></td><td style="width:20%">
    <div style="display:flex;gap:0.5rem;"><a href="" target="_blank" class="btn btn-outline btn-sm row-link">Listen</a><button type="button" class="btn btn-primary btn-sm row-share-btn">SHARE</button><form action="/admin/kick" method="POST" style="display:inline;" class="row-kick-form"><input type="hidden" name="csrf" value="{{.CSRFToken}}"><input type="hidden" name="mount" value=""><button type="submit" class="btn btn-danger btn-sm">KICK</button></form></div></td></tr></template>
    <template id="relay-row-template"><tr><td><div class="status-pill row-relay-status"><div class="dot"></div> <span class="row-relay-status-text"></span></div></td><td style="font-size:0.8rem;color:var(--text-dim)" class="row-relay-url"></td><td><span class="mount-code row-relay-mount"></span></td><td><div style="display:flex; gap:0.3rem"><button type="button" class="btn btn-outline btn-sm row-relay-edit-btn">EDIT</button><form action="/admin/toggle-visible" method="POST" class="row-relay-visible-form"><input type="hidden" name="csrf" value="{{.CSRFToken}}"><input type="hidden" name="mount" value=""><button type="submit" class="btn btn-sm row-relay-visible-btn"></button></form><form action="/admin/toggle-relay" method="POST" class="row-relay-toggle-form"><input type="hidden" name="csrf" value="{{.CSRFToken}}"><input type="hidden" name="mount" value=""><button type="submit" class="btn btn-sm row-relay-toggle-btn"></button></form><form action="/admin/delete-relay" method="POST" class="row-relay-delete-form"><input type="hidden" name="csrf" value="{{.CSRFToken}}"><input type="hidden" name="mount" value=""><button type="submit" class="btn btn-danger btn-sm">STOP</button></form></div></td></tr></template>
    <template id="transcoder-row-template">
        <tr>
            <td><div class="status-pill row-tc-status"><div class="dot"></div> <span class="row-tc-name"></span></div></td>
            <td style="font-size:0.75rem; color:var(--text-dim)"><span class="row-tc-input"></span> &rarr; <span class="row-tc-output"></span><br><strong class="row-tc-format"></strong></td>
            <td style="font-size:0.75rem;"><span class="row-tc-uptime"></span><br><span class="row-tc-bytes"></span></td>
            <td>
                <div style="display:flex; gap:0.3rem">
                    <form action="/admin/toggle-transcoder" method="POST"><input type="hidden" name="csrf" value="{{.CSRFToken}}"><input type="hidden" name="name" class="row-tc-hidden-name"><button type="submit" class="btn btn-sm row-tc-toggle-btn"></button></form>
                    <form action="/admin/delete-transcoder" method="POST" onsubmit="return confirm('Delete?')"><input type="hidden" name="csrf" value="{{.CSRFToken}}"><input type="hidden" name="name" class="row-tc-hidden-name-del"><button type="submit" class="btn btn-danger btn-sm">DELETE</button></form>
                </div>
            </td>
        </tr>
    </template>
    <script>
        function updateAutoDJProgress() {
            const bars = document.querySelectorAll('.progress-bar-adj');
            const now = Math.floor(Date.now() / 1000);
            
            bars.forEach(bar => {
                const startTime = parseInt(bar.dataset.start);
                if (!startTime) return;
                
                const elapsed = now - startTime;
                const card = bar.closest('.card');
                
                // For now, since we don't have exact duration from the backend easily
                // we'll use a placeholder logic or just show elapsed time.
                // In a real scenario, we'd fetch the current song duration.
                
                const currentEl = card.querySelector('.progress-time-current');
                if (currentEl) {
                    const m = Math.floor(elapsed / 60).toString().padStart(2, '0');
                    const s = Math.floor(elapsed % 60).toString().padStart(2, '0');
                    currentEl.textContent = `${m}:${s}`;
                }
            });
        }
        setInterval(updateAutoDJProgress, 1000);

        function initSortable() {
            document.querySelectorAll('.playlist-sortable').forEach(function(el) {
                new Sortable(el, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    handle: '.lucide-grip-vertical',
                    onEnd: function(evt) {
                        const mount = el.dataset.mount;
                        const from = evt.oldIndex;
                        const to = evt.newIndex;
                        if (from === to) return;
                        
                        const formData = new FormData();
                        formData.append('csrf', csrfToken);
                        formData.append('mount', mount);
                        formData.append('from', from);
                        formData.append('to', to);
                        
                        fetch('/admin/player/reorder', {
                            method: 'POST',
                            body: formData
                        }).then(r => {
                            if (!r.ok) alert('Failed to reorder playlist');
                        });
                    }
                });
            });
        }

        const csrfToken = "{{.CSRFToken}}";
        function showTab(id, updateHash) { 
            document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); }); 
            document.querySelectorAll('.nav-link').forEach(function(t) { t.classList.remove('active'); }); 
            document.getElementById(id).classList.add('active'); 
            var btn = Array.from(document.querySelectorAll('.nav-link')).find(function(b) { return b.getAttribute('onclick') && b.getAttribute('onclick').indexOf(id) !== -1; }); 
            if (btn) btn.classList.add('active'); 
            if (updateHash !== false) window.location.hash = id; 
            if (id === 'tab-insights') {
                fetchInsights();
                fetchStatistics();
            }
            if (id === 'tab-transcoding') fetchTranscoderStats();
            if (id === 'tab-security') fetchSecurityStats();
        }

        function fetchSecurityStats() {
            if (window.location.hash !== '#tab-security') return;
            fetch('/admin/security-stats').then(r => r.json()).then(data => {
                const authBody = document.getElementById('authFailsBody');
                const scanBody = document.getElementById('scannersBody');
                
                let authHtml = '';
                data.auth_fails.forEach(s => {
                    const status = s.locked ? `<span style="color:var(--danger); font-weight:bold">LOCKED (${s.expires_in})</span>` : 'Active';
                    authHtml += `<tr><td>${s.ip}</td><td>${s.count}</td><td>${status}</td><td><form action="/admin/clear-auth-lockout" method="POST"><input type="hidden" name="csrf" value="${csrfToken}"><input type="hidden" name="ip" value="${s.ip}"><button class="btn btn-sm btn-outline">CLEAR</button></form></td></tr>`;
                });
                authBody.innerHTML = authHtml || '<tr><td colspan="4" style="text-align:center; padding:1rem">No auth failures recorded.</td></tr>';

                let scanHtml = '';
                data.scanners.forEach(s => {
                    const status = s.locked ? `<span style="color:var(--danger); font-weight:bold">LOCKED (${s.expires_in})</span>` : 'Active';
                    scanHtml += `<tr><td>${s.ip}</td><td>${s.count}</td><td>${status}</td><td><form action="/admin/clear-scan-lockout" method="POST"><input type="hidden" name="csrf" value="${csrfToken}"><input type="hidden" name="ip" value="${s.ip}"><button class="btn btn-sm btn-outline">CLEAR</button></form></td></tr>`;
                });
                scanBody.innerHTML = scanHtml || '<tr><td colspan="4" style="text-align:center; padding:1rem">No scanning attempts recorded.</td></tr>';

                setTimeout(fetchSecurityStats, 2000);
            });
        }

        function fetchTranscoderStats() {
            fetch('/admin/transcoder-stats').then(r => r.json()).then(data => {
                const body = document.getElementById('transcodersBody');
                if (!body) return;
                const template = document.getElementById('transcoder-row-template');
                body.innerHTML = '';
                data.forEach(tc => {
                    const clone = template.content.cloneNode(true);
                    clone.querySelector('.row-tc-name').textContent = tc.name;
                    clone.querySelector('.row-tc-input').textContent = tc.input;
                    clone.querySelector('.row-tc-output').textContent = tc.output;
                    clone.querySelector('.row-tc-format').textContent = `${tc.format.toUpperCase()} ${tc.bitrate}K`;
                    clone.querySelector('.row-tc-uptime').textContent = tc.active ? `Up: ${tc.uptime}` : 'STOPPED';
                    clone.querySelector('.row-tc-bytes').textContent = formatBytes(tc.bytes);
                    
                    if (!tc.active) clone.querySelector('.row-tc-status').classList.add('inactive');
                    
                    const toggleBtn = clone.querySelector('.row-tc-toggle-btn');
                    toggleBtn.textContent = tc.active ? 'STOP' : 'START';
                    toggleBtn.classList.add(tc.active ? 'btn-warning' : 'btn-primary');
                    
                    clone.querySelector('.row-tc-hidden-name').value = tc.name;
                    clone.querySelector('.row-tc-hidden-name-del').value = tc.name;
                    body.appendChild(clone);
                });
                setTimeout(fetchTranscoderStats, 1000);
            });
        }

        function fetchStatistics() {
            if (window.location.hash !== '#tab-insights') return;
            fetch('/admin/statistics').then(function(r) { return r.json(); }).then(function(data) {
                var tsBody = document.getElementById('topStreamsBody');
                if (tsBody) {
                    tsBody.innerHTML = '';
                    data.top_streams.forEach(function(s) {
                        var row = document.createElement('tr');
                        row.innerHTML = '<td>' + s.MountName + '</td><td>' + s.Name + '</td><td style="font-weight:bold; color:var(--primary)">' + s.ListenersCount + '</td><td>' + s.Bitrate + '</td>';
                        tsBody.appendChild(row);
                    });
                }

                var tlUABody = document.getElementById('topListenersUABody');
                if (tlUABody && data.top_listeners_ua) {
                    tlUABody.innerHTML = '';
                    data.top_listeners_ua.forEach(function(ua) {
                        var row = document.createElement('tr');
                        row.innerHTML = '<td>' + (ua.ua || 'Unknown') + '</td><td style="font-weight:bold; color:var(--success)">' + ua.count + '</td>';
                        tlUABody.appendChild(row);
                    });
                }

                var tsUABody = document.getElementById('topSourcesUABody');
                if (tsUABody && data.top_sources_ua) {
                    tsUABody.innerHTML = '';
                    data.top_sources_ua.forEach(function(ua) {
                        var row = document.createElement('tr');
                        row.innerHTML = '<td>' + (ua.ua || 'Unknown') + '</td><td style="font-weight:bold; color:var(--warning)">' + ua.count + '</td>';
                        tsUABody.appendChild(row);
                    });
                }
                setTimeout(fetchStatistics, 5000);
            });
        }
        
        // Ensure forms redirect back to the current tab
        document.addEventListener('submit', function(e) {
            var form = e.target;
            if (form.method.toLowerCase() === 'post') {
                var action = form.getAttribute('action');
                if (action && action.indexOf('#') === -1) {
                    form.setAttribute('action', action + window.location.hash);
                }
            }
        });

        function loadHistory(mount, btn) {
            if (!mount) return;
            document.querySelectorAll('.history-mount-btn').forEach(function(b) { b.classList.remove('active'); });
            if (btn) btn.classList.add('active');
            document.getElementById('history-current-mount').innerText = 'History for ' + mount;
            var body = document.getElementById('historyBody');
            body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:5rem">Loading...</td></tr>';
            fetch('/admin/history?mount=' + encodeURIComponent(mount))
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    if (!data || data.length === 0) {
                        body.innerHTML = '<tr><td colspan="2" style="text-align:center; padding:5rem; color:var(--text-dim)">No history found for this mount.</td></tr>';
                        return;
                    }
                    var html = '';
                    data.forEach(function(item) {
                        var date = new Date(item.Timestamp).toLocaleString();
                        html += '<tr><td><span class="song-title">' + item.Song + '</span></td><td style="color:var(--text-dim); font-size:0.8rem">' + date + '</td></tr>';
                    });
                    body.innerHTML = html;
                });
        }

        function shareStream(mount) {
            var url = window.location.origin + '/embed' + mount;
            var code = '<iframe src="' + url + '" width="100%" height="80" frameborder="0" scrolling="no"></iframe>';
            prompt('Copy this code to embed your player:', code);
        }

        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        function fetchInsights() {
            fetch('/admin/insights').then(function(r) { return r.json(); }).then(function(data) {
                var canvas = document.getElementById('insightsChart');
                var ctx = canvas.getContext('2d');
                var w = canvas.width = canvas.offsetWidth * 2;
                var h = canvas.height = canvas.offsetHeight * 2;
                ctx.scale(2, 2); w /= 2; h /= 2;

                var pX = 50, pY = 30, cH = h - pY * 2, cW = w - pX * 1.5;
                ctx.clearRect(0, 0, w, h);

                var mounts = Object.keys(data);
                if (mounts.length === 0) {
                    ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'center';
                    ctx.fillText('No historical data available yet.', w/2, h/2);
                    return;
                }

                var colors = ['#38bdf8', '#10b981', '#fbbf24', '#f87171', '#a78bfa', '#f472b6'];
                var maxL = 0;
                mounts.forEach(function(m) {
                    data[m].forEach(function(d) { if (d.listeners > maxL) maxL = d.listeners; });
                });
                maxL = Math.ceil((maxL || 1) * 1.2);

                // Draw Y-Axis Labels & Grid
                ctx.strokeStyle = 'rgba(45, 55, 72, 0.3)'; ctx.fillStyle = '#94a3b8'; ctx.font = '10px Inter';
                ctx.textAlign = 'right'; ctx.lineWidth = 1;
                for(var i=0; i<=5; i++) {
                    var val = Math.round((maxL / 5) * i);
                    var y = (h - pY) - (val / maxL) * cH;
                    ctx.beginPath(); ctx.moveTo(pX, y); ctx.lineTo(w - 20, y); ctx.stroke();
                    ctx.fillText(val, pX - 10, y + 4);
                }

                // Draw X-Axis Labels (Time)
                ctx.textAlign = 'center';
                var timeLabels = ['-24h', '-18h', '-12h', '-6h', 'Now'];
                for(var i=0; i<timeLabels.length; i++) {
                    var x = pX + (cW / (timeLabels.length - 1)) * i;
                    ctx.fillText(timeLabels[i], x, h - 10);
                }

                var legend = document.getElementById('insights-legend');
                legend.innerHTML = '';
                
                var globalPeak = 0;
                var globalTraffic = 0;

                mounts.forEach(function(m, idx) {
                    var color = colors[idx % colors.length];
                    var streamData = data[m];
                    
                    var item = document.createElement('div');
                    item.style.fontSize = '0.75rem'; item.style.color = color; item.style.fontWeight = 'bold';
                    item.innerHTML = `<span style="display:inline-block; width:10px; height:10px; background:${color}; border-radius:50%; margin-right:5px"></span> ${m}`;
                    legend.appendChild(item);

                    if (streamData.length > 1) {
                        ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.beginPath();
                        var step = cW / (streamData.length - 1);
                        streamData.forEach(function(d, i) {
                            var x = pX + i * step;
                            var y = (h-pY) - (d.listeners / maxL) * cH;
                            if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
                            if (d.listeners > globalPeak) globalPeak = d.listeners;
                        });
                        ctx.stroke();
                        globalTraffic += (streamData[streamData.length-1].bytes_out - streamData[0].bytes_out);
                    }
                });

                var summary = document.getElementById('insights-summary');
                summary.innerHTML = `
                    <div class="stat-card"><div class="label">Total Peak (All)</div><div class="value">${globalPeak}</div></div>
                    <div class="stat-card"><div class="label">Total 24H Traffic</div><div class="value">${(globalTraffic / (1024*1024)).toFixed(2)} MB</div></div>
                    <div class="stat-card"><div class="label">Active Stations</div><div class="value">${mounts.length}</div></div>
                `;
            });
        }

        (function() {
            var canvas = document.getElementById('trafficChart'); var ctx = canvas.getContext('2d');
            var outRateEl = document.getElementById('outRate'); var inRateEl = document.getElementById('inRate');
            var streamsBody = document.getElementById('streamsBody'); var rowTemplate = document.getElementById('stream-row-template');
            var relaysBody = document.getElementById('relaysBody'); var relayTemplate = document.getElementById('relay-row-template');
            var gListeners = document.getElementById('global-listeners'); var gSources = document.getElementById('global-sources'); 
            var gMbIn = document.getElementById('global-mb-in'); var gMbOut = document.getElementById('global-mb-out');
            var gStreamers = document.getElementById('stat-streamers'); var gRelays = document.getElementById('stat-relays');
            var debugRam = document.getElementById('debug-ram'); var debugGoroutines = document.getElementById('debug-goroutines');
            var debugHeap = document.getElementById('debug-heap'); var debugStack = document.getElementById('debug-stack');
            var debugGC = document.getElementById('debug-gc'); var debugLoss = document.getElementById('debug-loss');
            var debugUptime = document.getElementById('debug-uptime');
            var isDebug = window.location.search.indexOf('debug') !== -1;
            if (isDebug) document.getElementById('debug-stats').style.display = 'block';

            function resize() { var rect = canvas.getBoundingClientRect(); canvas.width = rect.width * 2; canvas.height = rect.height * 2; ctx.scale(2, 2); }
            window.addEventListener('resize', resize); resize();
            var historyLen = 60; var dataIn = new Array(historyLen).fill(0); var dataOut = new Array(historyLen).fill(0);
            var lastIn = 0, lastOut = 0, first = true; var chartMax = 10; var streamHistory = {};
            function drawChart() {
                var w = canvas.width / 2, h = canvas.height / 2, pX = 45, pY = 40, cH = h - pY * 1.5 - 20, cW = w - pX - 20;
                ctx.clearRect(0, 0, w, h); var targetMax = Math.max.apply(Math, dataIn.concat(dataOut).concat([10])) * 1.2; chartMax += (targetMax - chartMax) * 0.1;
                ctx.strokeStyle = 'rgba(45, 55, 72, 0.5)'; ctx.fillStyle = '#94a3b8'; ctx.font = '10px Inter'; ctx.lineWidth = 1;
                ctx.beginPath(); ctx.moveTo(pX, h - pY); ctx.lineTo(w - 20, h - pY); ctx.stroke();
                ctx.textAlign = 'right'; for(var i=0; i<=4; i++) { var val = (chartMax / 4) * i, y = (h - pY) - (val / chartMax) * cH; ctx.globalAlpha = 0.5; ctx.beginPath(); ctx.moveTo(pX, y); ctx.lineTo(w - 20, y); ctx.stroke(); ctx.globalAlpha = 1; ctx.fillText(Math.round(val) + ' KB/s', pX - 8, y + 4); }
                var drawCurve = function(data, color) {
                    ctx.strokeStyle = color; ctx.lineWidth = 3; ctx.lineJoin = 'round'; ctx.beginPath(); var step = cW / (historyLen - 1);
                    var points = data.map(function(v, i) { return { x: pX + i * step, y: (h - pY) - (v / chartMax) * cH }; }); ctx.moveTo(points[0].x, points[0].y);
                    for (var i = 0; i < points.length - 1; i++) { var xc = (points[i].x + points[i + 1].x) / 2, yc = (points[i].y + points[i + 1].y) / 2; ctx.quadraticCurveTo(points[i].x, points[i].y, xc, yc); }
                    ctx.stroke(); var grad = ctx.createLinearGradient(0, pY, 0, h - pY); grad.addColorStop(0, color + '40'); grad.addColorStop(1, color + '05'); ctx.fillStyle = grad; ctx.lineTo(pX + cW, h - pY); ctx.lineTo(pX, h - pY); ctx.fill();
                };
                drawCurve(dataOut, '#38bdf8'); drawCurve(dataIn, '#10b981');
            }
            var es = new EventSource("/admin/events");
            es.onmessage = function(e) {
                var data = JSON.parse(e.data); if (first) { lastIn = data.bytes_in; lastOut = data.bytes_out; first = false; return; }
                var rIn = (data.bytes_in - lastIn) / 1024, rOut = (data.bytes_out - lastOut) / 1024; lastIn = data.bytes_in; lastOut = data.bytes_out;
                inRateEl.innerText = rIn.toFixed(1); outRateEl.innerText = rOut.toFixed(1); dataIn.shift(); dataIn.push(rIn); dataOut.shift(); dataOut.push(rOut); drawChart();
                gListeners.innerText = data.total_listeners; gSources.innerText = data.total_sources; 
                gStreamers.innerText = data.total_streamers; gRelays.innerText = data.total_relays;
                                                gMbIn.innerText = (data.bytes_in / (1024 * 1024)).toFixed(2); gMbOut.innerText = (data.bytes_out / (1024 * 1024)).toFixed(2);
                                                if (debugRam) {
                                                    debugRam.innerText = formatBytes(data.sys_ram);
                                                    debugHeap.innerText = formatBytes(data.heap_alloc);
                                                    debugStack.innerText = formatBytes(data.stack_sys);
                                                    debugGC.innerText = data.num_gc;
                                                    debugGoroutines.innerText = data.goroutines;
                                                    debugLoss.innerText = formatBytes(data.total_dropped);
                                                    debugUptime.innerText = data.server_uptime;
                                                }
                                                                streamsBody.innerHTML = ''; if (data.streams.length > 0) {
                
                    data.streams.forEach(function(s) {
                        var prev = streamHistory[s.mount] || { in: s.bytes_in, out: s.bytes_out }; var curIn = (s.bytes_in - prev.in) / 1024, curOut = (s.bytes_out - prev.out) / 1024; streamHistory[s.mount] = { in: s.bytes_in, out: s.bytes_out };
                        var clone = rowTemplate.content.cloneNode(true);
                        
                        var mountCell = clone.querySelector('.row-mount');
                        mountCell.textContent = s.mount;
                        if (s.ip === 'relay-pull') {
                            var badge = document.createElement('span');
                            badge.className = 'badge-transcoded';
                            badge.style.background = 'rgba(56, 189, 248, 0.1)';
                            badge.style.color = '#38bdf8';
                            badge.style.borderColor = 'rgba(56, 189, 248, 0.2)';
                            badge.textContent = 'RELAY';
                            mountCell.parentElement.appendChild(badge);
                        } else if (s.is_transcoded) {
                            var badge = document.createElement('span');
                            badge.className = 'badge-transcoded';
                            badge.textContent = 'TRANSCODED';
                            mountCell.parentElement.appendChild(badge);
                        }

                        clone.querySelector('.row-ip').textContent = s.ip; clone.querySelector('.row-song').textContent = s.song;
                        clone.querySelector('.row-listeners').textContent = s.listeners; clone.querySelector('.row-in').textContent = curIn.toFixed(1); clone.querySelector('.row-out').textContent = curOut.toFixed(1);
                        
                        var health = s.health;
                        var hEl = clone.querySelector('.row-health');
                        hEl.textContent = health.toFixed(1) + '%';
                        hEl.style.color = health > 95 ? 'var(--success)' : (health > 80 ? 'var(--warning)' : 'var(--danger)');
                        hEl.style.fontWeight = 'bold';

                        clone.querySelector('.row-uptime').textContent = s.uptime; 
                        clone.querySelector('.row-link').setAttribute('href', '/player' + s.mount);
                        clone.querySelector('.row-share-btn').onclick = function() { shareStream(s.mount); };
                        clone.querySelector('.row-kick-form input').value = s.mount; streamsBody.appendChild(clone);
                    });
                }
                if (relaysBody && data.relays) {
                    relaysBody.innerHTML = '';
                    data.relays.forEach(function(r) {
                        var clone = relayTemplate.content.cloneNode(true);
                        clone.querySelector('.row-relay-url').textContent = r.url; 
                        clone.querySelector('.row-relay-mount').textContent = r.mount;
                        clone.querySelector('.row-relay-status-text').textContent = r.active ? 'ACTIVE' : 'IDLE';
                        if (!r.active) clone.querySelector('.row-relay-status').classList.add('inactive');
                        
                        var visBtn = clone.querySelector('.row-relay-visible-btn');
                        var isVisible = data.visible_mounts && data.visible_mounts[r.mount];
                        visBtn.textContent = isVisible ? 'HIDE' : 'APPROVE';
                        visBtn.classList.add(isVisible ? 'btn-outline' : 'btn-primary');
                        clone.querySelector('.row-relay-visible-form input').value = r.mount;

                        var togBtn = clone.querySelector('.row-relay-toggle-btn');
                        togBtn.textContent = r.enabled ? 'STOP' : 'START';
                        togBtn.classList.add(r.enabled ? 'btn-warning' : 'btn-primary');
                        clone.querySelector('.row-relay-toggle-form input').value = r.mount;

                        clone.querySelector('.row-relay-toggle-form input').value = r.mount;
                        clone.querySelector('.row-relay-delete-form input').value = r.mount;
                        
                        clone.querySelector('.row-relay-edit-btn').onclick = function() {
                            document.getElementById('add-relay-url').value = r.url;
                            document.getElementById('add-relay-mount').value = r.mount;
                            document.getElementById('add-relay-burst').value = 20; // Default
                            showTab('tab-relays');
                            document.getElementById('add-relay-password').focus();
                        };

                        relaysBody.appendChild(clone);
                    });
                }
            };
            document.getElementById('gen-pw').addEventListener('click', function() {
                var chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"; var pw = ""; for (var i = 0; i < 16; i++) pw += chars.charAt(Math.floor(Math.random() * chars.length)); document.getElementById('new-mount-pw').value = pw;
            });
            document.addEventListener('click', function(e) { if (e.target.classList.contains('edit-mount')) { document.getElementById('add-mount-path').value = e.target.dataset.mount; showTab('tab-stations'); document.getElementById('new-mount-pw').focus(); } });

            drawChart();
            lucide.createIcons();
            initSortable();
            if (window.location.hash) { var it = window.location.hash.substring(1); if (document.getElementById(it)) { showTab(it, false); } }
        })();
    </script>
</body>
</html>
